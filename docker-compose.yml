services:
# traefik
  traefik:
    image: traefik:latest
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - perplexica-net
      - open-webui-net

# Perplexica
  searxng:
      image: docker.io/searxng/searxng:latest
      volumes:
        - ./Perplexica/searxng:/etc/searxng:rw
      ports:
        - 4000:8080
      networks:
        - perplexica-net
      restart: unless-stopped

    perplexica-backend:
      build:
        context: ./Perplexica
        dockerfile: backend.dockerfile
      image: itzcrazykns1337/perplexica-backend:main
      environment:
        - SEARXNG_API_URL=http://searxng:8080
      depends_on:
        - searxng
      ports:
        - 3001:3001
      volumes:
        - backend-dbstore:/home/perplexica/data
        - ./Perplexica/config.toml:/home/perplexica/config.toml
      extra_hosts:
        - 'host.docker.internal:host-gateway'
      networks:
        - perplexica-net
      restart: unless-stopped

    perplexica-frontend:
      build:
        context: ./Perplexica
        dockerfile: app.dockerfile
        args:
          - NEXT_PUBLIC_API_URL=http://127.0.0.1:3001/api
          - NEXT_PUBLIC_WS_URL=ws://127.0.0.1:3001
      image: itzcrazykns1337/perplexica-frontend:main
      depends_on:
        - perplexica-backend
      ports:
        - 3030:3000
      networks:
        - perplexica-net
      restart: unless-stopped
      labels:
        - "traefik.http.routers.perplexica-frontend.rule=Host(perplexica.local)"
        - "traefik.docker.network=perplexica-net"

# open-webUI for ollama
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - open-webui:/app/backend/data
    ports:
      - 3000:8080
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - open-webui-net
    restart: unless-stopped
    labels:
      - "traefik.http.routers.open-webui.rule=Host(open-webui.local)"
      - "traefik.docker.network=open-webui-net"

networks:
  perplexica-net:
  open-webui-net:


volumes:
  backend-dbstore:
  open-webui: {}